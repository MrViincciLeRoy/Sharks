name: Complete Database Reset (Drop All Tables)

on:
  workflow_dispatch:
    inputs:
      confirm_reset:
        description: 'Type "RESET" to confirm complete wipe'
        required: true
        default: ''

jobs:
  complete-reset:
    runs-on: ubuntu-latest
    
    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirm_reset }}" != "RESET" ]; then
            echo "‚ùå Confirmation failed. You must type 'RESET' to proceed."
            exit 1
          fi
          echo "‚úÖ Confirmation received. Proceeding with complete reset..."

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install PostgreSQL client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Drop ALL database objects (tables, views, sequences, functions)
        env:
          PGHOST: ${{ secrets.PGHOST }}
          PGPORT: ${{ secrets.PGPORT }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGSSLMODE: require
        run: |
          echo "üóëÔ∏è  Dropping ALL objects from database: ${PGDATABASE}"
          echo "This will remove tables, sequences, views, functions, and types"
          
          PGPASSWORD="${PGPASSWORD}" psql -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}" -d "${PGDATABASE}" << 'EOF'
          DO $$ 
          DECLARE
              r RECORD;
          BEGIN
              -- Drop all views first (they might depend on tables)
              FOR r IN (
                  SELECT table_name 
                  FROM information_schema.views 
                  WHERE table_schema = 'public'
              )
              LOOP
                  EXECUTE 'DROP VIEW IF EXISTS public.' || quote_ident(r.table_name) || ' CASCADE';
                  RAISE NOTICE 'Dropped view: %', r.table_name;
              END LOOP;
              
              -- Drop all materialized views
              FOR r IN (
                  SELECT matviewname 
                  FROM pg_matviews 
                  WHERE schemaname = 'public'
              )
              LOOP
                  EXECUTE 'DROP MATERIALIZED VIEW IF EXISTS public.' || quote_ident(r.matviewname) || ' CASCADE';
                  RAISE NOTICE 'Dropped materialized view: %', r.matviewname;
              END LOOP;
              
              -- Drop all tables with CASCADE to handle foreign keys
              FOR r IN (
                  SELECT tablename 
                  FROM pg_tables 
                  WHERE schemaname = 'public'
              ) 
              LOOP
                  EXECUTE 'DROP TABLE IF EXISTS public.' || quote_ident(r.tablename) || ' CASCADE';
                  RAISE NOTICE 'Dropped table: %', r.tablename;
              END LOOP;
              
              -- Drop all sequences
              FOR r IN (
                  SELECT sequence_name 
                  FROM information_schema.sequences 
                  WHERE sequence_schema = 'public'
              )
              LOOP
                  EXECUTE 'DROP SEQUENCE IF EXISTS public.' || quote_ident(r.sequence_name) || ' CASCADE';
                  RAISE NOTICE 'Dropped sequence: %', r.sequence_name;
              END LOOP;
              
              -- Drop all functions
              FOR r IN (
                  SELECT proname, 
                         oidvectortypes(proargtypes) as argtypes
                  FROM pg_proc 
                  INNER JOIN pg_namespace ns ON (pg_proc.pronamespace = ns.oid)
                  WHERE ns.nspname = 'public'
              )
              LOOP
                  EXECUTE 'DROP FUNCTION IF EXISTS public.' || quote_ident(r.proname) || 
                          '(' || r.argtypes || ') CASCADE';
                  RAISE NOTICE 'Dropped function: %', r.proname;
              END LOOP;
              
              -- Drop all custom types
              FOR r IN (
                  SELECT typname
                  FROM pg_type
                  WHERE typnamespace = 'public'::regnamespace
                    AND typtype = 'c'
              )
              LOOP
                  EXECUTE 'DROP TYPE IF EXISTS public.' || quote_ident(r.typname) || ' CASCADE';
                  RAISE NOTICE 'Dropped type: %', r.typname;
              END LOOP;
              
              RAISE NOTICE '‚úÖ All database objects dropped successfully';
          END $$;
          EOF
          
          echo "‚úÖ Database completely cleared"

      - name: Verify database is empty
        env:
          PGHOST: ${{ secrets.PGHOST }}
          PGPORT: ${{ secrets.PGPORT }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGSSLMODE: require
        run: |
          echo "üîç Verifying database is empty..."
          
          TABLE_COUNT=$(PGPASSWORD="${PGPASSWORD}" psql -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}" -d "${PGDATABASE}" -tAc \
            "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';")
          
          VIEW_COUNT=$(PGPASSWORD="${PGPASSWORD}" psql -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}" -d "${PGDATABASE}" -tAc \
            "SELECT COUNT(*) FROM information_schema.views WHERE table_schema = 'public';")
          
          SEQ_COUNT=$(PGPASSWORD="${PGPASSWORD}" psql -h "${PGHOST}" -p "${PGPORT}" -U "${PGUSER}" -d "${PGDATABASE}" -tAc \
            "SELECT COUNT(*) FROM information_schema.sequences WHERE sequence_schema = 'public';")
          
          echo "üìä Database status:"
          echo "  - Tables: ${TABLE_COUNT}"
          echo "  - Views: ${VIEW_COUNT}"
          echo "  - Sequences: ${SEQ_COUNT}"
          
          if [ "$TABLE_COUNT" -eq "0" ] && [ "$VIEW_COUNT" -eq "0" ] && [ "$SEQ_COUNT" -eq "0" ]; then
            echo "‚úÖ Database is completely clean!"
          else
            echo "‚ö†Ô∏è Warning: Some objects still exist"
            exit 1
          fi

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build initialization Docker image
        run: |
          echo "üèóÔ∏è  Building Docker image..."
          docker build -f Dockerfile.init -t odoo-init .

      - name: Initialize Fresh Odoo Database
        env:
          PGHOST: ${{ secrets.PGHOST }}
          PGPORT: ${{ secrets.PGPORT }}
          PGUSER: ${{ secrets.PGUSER }}
          PGPASSWORD: ${{ secrets.PGPASSWORD }}
          PGDATABASE: ${{ secrets.PGDATABASE }}
          PGSSLMODE: require
        run: |
          echo "üöÄ Installing Odoo with all modules..."
          docker run --rm \
            -e PGHOST="${PGHOST}" \
            -e PGPORT="${PGPORT}" \
            -e PGUSER="${PGUSER}" \
            -e PGPASSWORD="${PGPASSWORD}" \
            -e PGDATABASE="${PGDATABASE}" \
            -e PGSSLMODE="${PGSSLMODE}" \
            odoo-init

      - name: Reset Complete
        run: |
          echo "‚úÖ Complete database reset finished!"
          echo ""
          echo "üìã What was done:"
          echo "  1. ‚úÖ Dropped all views and materialized views"
          echo "  2. ‚úÖ Dropped all tables with CASCADE"
          echo "  3. ‚úÖ Dropped all sequences"
          echo "  4. ‚úÖ Dropped all functions and types"
          echo "  5. ‚úÖ Verified database is empty"
          echo "  6. ‚úÖ Fresh Odoo installation completed"
          echo ""
          echo "üì¶ Installed modules:"
          echo "  ‚Ä¢ base"
          echo "  ‚Ä¢ account"
          echo "  ‚Ä¢ GMailer"
          echo "  ‚Ä¢ erpnext_connector"
          echo "  ‚Ä¢ gmail_erpnext_bridge"
          echo ""
          echo "üîê Default credentials:"
          echo "  Username: admin"
          echo "  Password: admin"
          echo ""
          echo "üéâ Your Odoo database is ready!"
