from odoo import models, fields, api
from odoo.exceptions import UserError
import json

class GoogleCredentials(models.Model):
    _name = 'google.credentials'
    _description = 'Google OAuth Credentials'

    name = fields.Char(string='Name', required=True)
    user_id = fields.Many2one('res.users', string='User', required=True, default=lambda self: self.env.user)
    client_id = fields.Char(string='Client ID', required=True)
    client_secret = fields.Char(string='Client Secret', required=True)
    access_token = fields.Text(string='Access Token')
    refresh_token = fields.Text(string='Refresh Token')
    token_expiry = fields.Datetime(string='Token Expiry')
    is_authenticated = fields.Boolean(string='Authenticated', compute='_compute_is_authenticated', store=True)
    
    @api.depends('access_token', 'refresh_token')
    def _compute_is_authenticated(self):
        for record in self:
            record.is_authenticated = bool(record.access_token and record.refresh_token)
    
    def action_authenticate(self):
        """Redirect to Google OAuth page"""
        base_url = self.env['ir.config_parameter'].sudo().get_param('web.base.url')
        redirect_uri = f"{base_url}/google_auth/callback"
        
        auth_url = (
            f"https://accounts.google.com/o/oauth2/v2/auth?"
            f"client_id={self.client_id}&"
            f"redirect_uri={redirect_uri}&"
            f"response_type=code&"
            f"scope=https://www.googleapis.com/auth/gmail.readonly&"
            f"access_type=offline&"
            f"prompt=consent&"
            f"state={self.id}"
        )
        
        return {
            'type': 'ir.actions.act_url',
            'url': auth_url,
            'target': 'self',
        }
    
    def action_revoke(self):
        """Revoke authentication"""
        self.write({
            'access_token': False,
            'refresh_token': False,
            'token_expiry': False,
        })